<video id="video" controls autoplay></video>
<script src="~/lib/signalr/signalr.js"></script>
<script>
(async () => {
  const conn = new signalR.HubConnectionBuilder()
      .withUrl("/videoHub").build();
  await conn.start();

  const video = document.getElementById('video');
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  // Async iterator of frames
  const frames = {
    async *[Symbol.asyncIterator]() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      while (true) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const blob = await new Promise(res =>
          canvas.toBlob(res, 'image/jpeg', 0.7));
        yield new Uint8Array(await blob.arrayBuffer());
        await new Promise(r => setTimeout(r, 100));
      }
    }
  };

  // Stream to server
  await conn.send("UploadVideoStream", frames);
})();
</script>
